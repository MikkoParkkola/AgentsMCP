# P6.2 – User‑Friendly Configuration System (Design)

Goal: Make setup as simple as Claude Code CLI for non‑developers while preserving powerful automation and orchestration for advanced users. The system auto‑detects the environment, applies smart defaults, and composes the best agent/team per task.

## Overview
- Zero‑config first run: sensible defaults with local‑first routing and graceful fallbacks.
- One‑screen friendly wizard: minimal questions; pre‑filled by auto‑detection.
- Role preferences: intuitive per‑role choices with budget, privacy, and speed hints.
- Auto‑compose teams: map task types to role pipelines and select optimal agents per stage.
- Always overridable: advanced users can edit YAML or use CLI flags to override any choice.

---

## 1) Configuration Schema – Role Preferences & Routing

Introduce a minimal, user‑oriented layer on top of existing `Config` that can be expressed in a few lines of YAML, while the Pydantic layer retains depth and validation.

### YAML (simple) – lives at `~/.agentsmcp/agentsmcp.yaml`
```yaml
# Minimal, friendly preferences (advanced keys are optional)
quick_prefs:
  usage_mode: balanced        # fast-free | balanced | premium
  privacy_mode: true          # prefer local tools/providers
  default_team: auto          # auto | solo | full_review

role_preferences:
  coder:
    agent_order: ["ollama-turbo", "codex", "ollama"]
    model_priority: ["gpt-oss:120b", "gpt-4o-mini"]
    constraints:
      offline_ok: true
      budget: low             # low | medium | high
      speed: high             # low | medium | high
  architect:
    agent_order: ["codex", "claude", "ollama-turbo"]
    model_priority: ["gpt-4o", "claude-3.7"]
  qa:
    agent_order: ["ollama-turbo", "codex"]

routing:
  strategy: best_available     # best_available | cost_optimized | privacy_first
  auto_team: true
  team_templates:
    feature_impl:
      - role: architect
      - role: coder
      - role: qa
      - role: merge_bot
    docs_update:
      - role: docs
      - role: qa

autodetect:
  enabled: true
  last_snapshot_file: ~/.agentsmcp/last_detect.json
```

### Pydantic schema (advanced)
Add the following to `src/agentsmcp/config.py` (names illustrative):
```python
class RolePreference(BaseModel):
    agent_order: List[str] = Field(default_factory=list)
    model_priority: List[str] = Field(default_factory=list)
    constraints: Dict[str, Any] = Field(default_factory=dict)  # budget, speed, offline_ok, privacy
    tool_overrides: List[str] = Field(default_factory=list)
    mcp_servers: List[str] = Field(default_factory=list)

class TeamStage(BaseModel):
    role: RoleName
    gate: Optional[str] = Field(default=None, description="optional quality gate id")
    parallel_group: Optional[str] = None  # run stages with same group in parallel

class RoutingPolicy(BaseModel):
    strategy: str = Field(default="best_available")  # or cost_optimized, privacy_first
    auto_team: bool = Field(default=True)
    team_templates: Dict[str, List[TeamStage]] = Field(default_factory=dict)

class EnvironmentCapabilities(BaseModel):
    online: bool = True
    providers: Dict[str, Dict[str, Any]] = Field(default_factory=dict)  # {name: {ready: bool, reason: str}}
    local_models: List[str] = Field(default_factory=list)
    gpu: bool = False
    os: str = Field(default_factory=lambda: platform.system())

class UXQuickPrefs(BaseModel):
    usage_mode: str = Field(default="balanced")
    privacy_mode: bool = Field(default=False)
    default_team: str = Field(default="auto")

class ExtendedConfig(Config):
    quick_prefs: UXQuickPrefs = Field(default_factory=UXQuickPrefs)
    role_preferences: Dict[str, RolePreference] = Field(default_factory=dict)
    routing: RoutingPolicy = Field(default_factory=RoutingPolicy)
    autodetect_enabled: bool = Field(default=True)
    env_capabilities: EnvironmentCapabilities = Field(default_factory=EnvironmentCapabilities)
```
Notes:
- Keep `Config` backward compatible; `ExtendedConfig` can be merged into `Config` or used as a drop‑in replacement.
- `RoleName` already exists under `roles.base`; import carefully to avoid cycles.

---

## 2) Task → Team Mapping Strategy

Layer 1: Lightweight classification (no API calls)
- Heuristics on `objective` and `inputs` keywords to map to a `task_category` (e.g., `feature_impl`, `bugfix`, `docs_update`, `refactor`, `experiment`, `analysis_only`).

Layer 2: Team template selection
- Use `routing.team_templates[task_category]` if present, else default:
  - feature_impl → [architect → coder → qa → merge_bot]
  - bugfix → [coder → qa]
  - refactor → [architect → coder → qa]
  - docs_update → [docs → qa]
  - experiment/analysis → [architect] or [coder] solo

Layer 3: Per‑stage agent selection
- For each stage, choose agent via `role_preferences[role].agent_order` ∩ available providers/models from `env_capabilities`.
- Apply `routing.strategy`:
  - best_available: prefer fastest known with required context window.
  - cost_optimized: prefer local/cheap (`ollama-turbo`, `ollama`) first.
  - privacy_first: strictly local unless overridden.

Layer 4: Fallbacks and gates
- If no provider ready, degrade gracefully to “analysis‑only” output with setup instructions.
- Respect `TeamStage.gate` to run QA or validations before advancing; run `parallel_group`s concurrently.

---

## 3) User‑Friendly Configuration Approach

- Minimal YAML: 5–10 lines sets powerful defaults; everything else optional.
- First‑run wizard (`agentsmcp setup`):
  - Shows detected environment and recommends a profile (fast‑free, balanced, premium).
  - Asks 3–4 questions max; default is Enter to accept.
  - Writes `~/.agentsmcp/agentsmcp.yaml` and saves detection snapshot.
- Friendly CLI affordances:
  - `agentsmcp doctor` → prints readiness with emojis and clear suggestions.
  - `agentsmcp config show` → renders human summary of effective config.
  - `agentsmcp config edit` → opens YAML in default editor with comments.
- Safe by default: privacy_mode on when no cloud keys detected.

---

## 4) Auto‑Detection Mechanisms

Implement `src/agentsmcp/detect.py` with small, fast checks:
- Network: attempt DNS + lightweight HEAD to `https://example.com` (with timeout) → `online`.
- Providers: check env or saved keys for OpenAI/OpenRouter; optional “ping” with opt‑in flag.
- Local models: probe `ollama` daemon or `ollama‑turbo` MCP; list known models if available.
- GPU/CPU: best‑effort detection (`nvidia-smi`, `Metal` on macOS via `sysctl`), but do not block.
- OS + shell: `platform.system()`, default editor from env.
Returns `EnvironmentCapabilities` and stores JSON snapshot (path from config).

Policy application:
- If `privacy_mode=true` or offline → force local agents and disable remote lookups.
- If `usage_mode=fast-free` → default to `ollama-turbo` with `gpt-oss:120b`, fallback `ollama` 20b.
- If large context tasks detected → pick `claude`/`gpt-4o` when keys ready and policy allows.

---

## 5) Implementation Breakdown (Small Tasks)

P6.2‑A – Schema
- Add `RolePreference`, `TeamStage`, `RoutingPolicy`, `EnvironmentCapabilities`, `UXQuickPrefs` to config models.
- Extend `Config` (or add `ExtendedConfig`) with new fields; wire YAML load/save.

P6.2‑B – Detection
- Create `detect.py` with functions: `detect_network()`, `detect_providers()`, `detect_ollama()`, `detect_gpu()`, `build_capabilities()`.
- Add `agentsmcp doctor` to print a human summary and persist snapshot.

P6.2‑C – Wizard
- Add `setup_wizard.py` and `agentsmcp setup` CLI.
- Flow: greet → show detected profile → ask 3–4 friendly questions → write YAML.
- Provide `--non-interactive --accept-defaults` for CI.

P6.2‑D – Delegation integration
- Update `DelegationEngine` to consider `role_preferences` and `routing.strategy`.
- When composing candidates, intersect `agent_order` with available providers from `env_capabilities`.

P6.2‑E – Team composition
- Implement lightweight classifier in coordinator to produce `task_category`.
- Build a team plan from `routing.team_templates[category]` with gates and optional parallel groups.
- Execute plan serially/with parallel blocks; reuse existing quality gates where present.

P6.2‑F – Defaults & safety
- Ship defaults that require no keys: `ollama-turbo` first, fallback to `ollama`, then degrade to analysis‑only with guidance.
- Respect privacy_mode everywhere; no outbound calls unless policy allows.

P6.2‑G – UX & Docs
- Update `docs/configuration.md` with a “simple vs advanced” section and examples.
- Add screenshots/GIFs for wizard and `doctor`.
- Include migration note to keep existing configs working.

P6.2‑H – Tests
- Unit tests for detection functions (offline/online, provider readiness parsing).
- Tests for agent selection given different policies and capabilities.
- Golden tests for team templates mapping per task category.

---

## Smart Defaults (Out‑of‑Box)
- Default agent for coding: `ollama-turbo` with `gpt-oss:120b`.
- Fallback order: `ollama-turbo` → `ollama (20b)` → analysis‑only.
- Defaults keep tools: `filesystem`, `git`, `bash` enabled.
- RAG disabled by default.
- UI dashboard disabled by default; can be toggled via `ui_enabled`.

## Non‑Goals
- Heavy provider probing on first run (avoid rate limits); probing is opt‑in.
- Complex ML classifiers for tasks; start with heuristics and extend later.

## Rollout & Backward Compatibility
- Keep legacy `Config` fields; new keys are additive.
- If `role_preferences` absent, use existing `Role.preferred_agent_type()` behavior and current fallbacks.
- Wizard only writes minimal `quick_prefs`, `role_preferences` for `coder`, and `routing.strategy`—everything else implicit.

---

## Example: Minimal YAML produced by wizard
```yaml
quick_prefs:
  usage_mode: fast-free
  privacy_mode: true
  default_team: auto
role_preferences:
  coder:
    agent_order: ["ollama-turbo", "ollama"]
    model_priority: ["gpt-oss:120b", "gpt-oss:20b"]
routing:
  strategy: privacy_first
  auto_team: true
```

This fits non‑developers: 8 lines, production‑ready defaults, and automatic per‑task optimization.
