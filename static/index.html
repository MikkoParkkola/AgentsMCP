<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <!-- Basic meta -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentsMCP Dashboard</title>

    <!-- Bootstrap 5 (CSS only) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-9ndCyUaJk9x0v5L7gH4y0V4R6L6c9M6Gz4WZ8n9xVw5k5N5aB2yH5+XwKk0C7YVb"
          crossorigin="anonymous">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
            integrity="sha384-8C+g5Gq2aHhK9zEONaX+K9r2FvT0Bz5JjG3r+8PjKx5lF+zL9s8T7h9h1v9+F6t"
            crossorigin="anonymous"></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Custom CSS -->
    <link href="/static/css/dashboard.css" rel="stylesheet">

</head>
<body class="bg-body">

    <!-- Global banner for readiness/errors -->
    <div id="globalBanner" class="alert alert-warning text-center rounded-0 d-none" role="alert" style="margin-bottom:0;">
        <i class="bi bi-exclamation-triangle me-2"></i>
        System not ready yet. Retrying connection...
    </div>

    <!-- ==== NAVBAR ==== -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-cpu me-2"></i>
                AgentsMCP
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNav" aria-controls="navbarNav"
                    aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="dashboard">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="agents">
                            <i class="bi bi-robot me-1"></i>Agents
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="monitoring">
                            <i class="bi bi-activity me-1"></i>Monitoring
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="tasks">
                            <i class="bi bi-list-task me-1"></i>Tasks
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="configuration">
                            <i class="bi bi-gear me-1"></i>Configuration
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item me-2">
                        <button id="themeToggle" class="btn btn-outline-light btn-sm" title="Toggle dark / light">
                            <i class="bi bi-moon"></i>
                        </button>
                    </li>
                    <li class="nav-item d-none d-lg-block">
                        <span id="usernameDisplay" class="text-white me-3"></span>
                    </li>
                    <li class="nav-item">
                        <button id="logoutBtn" class="btn btn-outline-light btn-sm">
                            <i class="bi bi-box-arrow-right me-1"></i>Logout
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ==== MAIN CONTENT ==== -->
    <main class="container-fluid my-4">

        <!-- Login form (shown only when not authenticated) -->
        <section id="loginSection" class="row justify-content-center d-none">
            <div class="col-md-4 col-sm-8">
                <div class="card shadow-sm">
                    <div class="card-header text-center bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-lock me-2"></i>Login
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="loginUsername" class="form-label">Username</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <input type="text" class="form-control" id="loginUsername" 
                                           required autocomplete="username" placeholder="admin">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="loginPassword" class="form-label">Password</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-key"></i></span>
                                    <input type="password" class="form-control" id="loginPassword" 
                                           required autocomplete="current-password" placeholder="admin">
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-box-arrow-in-right me-1"></i>Sign in
                                </button>
                            </div>
                            <div id="loginError" class="alert alert-danger mt-3 d-none" role="alert"></div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard widgets -->
        <section id="dashboardSection" class="row g-4 d-none">

            <!-- System health widget -->
            <div class="col-12 col-lg-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-heart-pulse me-2"></i>System Health
                        </h5>
                    </div>
                    <div class="card-body" id="systemHealthBody">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            Loading system health...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent status chart -->
            <div class="col-12 col-lg-8">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-pie-chart me-2"></i>Agents Overview
                        </h5>
                        <button id="refreshAgentsBtn" class="btn btn-sm btn-outline-light">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <canvas id="agentsChart" aria-label="Agents status chart" role="img"></canvas>
                    </div>
                </div>
            </div>

            <!-- Task queue widget -->
            <div class="col-12 col-lg-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-clock me-2"></i>Task Queue
                        </h5>
                        <button id="refreshTasksBtn" class="btn btn-sm btn-outline-light">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body overflow-auto" style="max-height: 300px;">
                        <table class="table table-sm table-hover mb-0" id="tasksTable">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Agent</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody class="align-middle">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                        <p id="tasksEmpty" class="text-center text-muted mt-3 d-none">No tasks found.</p>
                    </div>
                </div>
            </div>

            <!-- Recent events (SSE) -->
            <div class="col-12 col-lg-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-broadcast me-2"></i>Live Events
                        </h5>
                    </div>
                    <div class="card-body overflow-auto" style="max-height: 300px;">
                        <ul class="list-group list-group-flush" id="eventsList">
                            <li class="list-group-item text-muted">
                                <i class="bi bi-clock-history me-2"></i>Waiting for events…
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </section>

        <!-- System Metrics & Performance Charts (WUI5) -->
        <section id="metricsSection" class="container-fluid py-4 d-none">
            
            <!-- Metrics Dashboard Header -->
            <div class="row mb-4 align-items-center">
                <div class="col">
                    <h2 class="h4 mb-0">
                        <i class="bi bi-graph-up me-2"></i>System Performance & Metrics
                    </h2>
                </div>
                <div class="col-auto">
                    <!-- Time range selector -->
                    <div class="btn-group" role="group" aria-label="Time range selection">
                        <button type="button" class="btn btn-outline-secondary btn-sm timeline-btn active"
                                data-from="5m" data-to="now" aria-pressed="true">5min</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm timeline-btn"
                                data-from="1h" data-to="now" aria-pressed="false">1hr</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm timeline-btn"
                                data-from="24h" data-to="now" aria-pressed="false">24hr</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm timeline-btn"
                                data-from="7d" data-to="now" aria-pressed="false">7day</button>
                    </div>
                    
                    <!-- Export & Refresh buttons -->
                    <button type="button" class="btn btn-outline-success btn-sm ms-2" 
                            id="btn-export-metrics" aria-label="Export metrics as CSV">
                        <i class="bi bi-download me-1"></i>Export CSV
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm ms-1" 
                            id="btn-refresh-metrics" aria-label="Refresh all metrics">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>

            <!-- Live connection indicator -->
            <div id="metrics-connection-status" class="mb-3">
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2" id="connection-badge">
                        <i class="bi bi-wifi"></i> Connected
                    </span>
                    <small class="text-muted" id="last-update-time">Last updated: --</small>
                </div>
            </div>

            <!-- Metrics Widget Grid -->
            <div class="row" id="metrics-widget-grid" aria-live="polite">
                <!-- Dynamic metric cards will be inserted here -->
            </div>

            <!-- System Overview Cards -->
            <div class="row mt-4">
                <!-- Agent Performance Summary -->
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-robot me-2"></i>Agent Performance Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="agent-performance-chart" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Task Execution Analytics -->
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-bar-chart me-2"></i>Task Execution Analytics
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="task-analytics-chart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Alerts & Anomalies -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>Performance Alerts & Anomalies
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" id="clear-alerts-btn">
                                <i class="bi bi-trash me-1"></i>Clear All
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="performance-alerts-container">
                                <div class="text-muted text-center py-3">
                                    <i class="bi bi-check-circle me-2"></i>No performance issues detected
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <!-- Agent Monitoring Section (WUI3) -->
        <section id="monitoringSection" class="d-none">
            <div class="container-fluid py-4" id="agent-monitoring-root">

                <!-- Toolbar – search, filter, alerts -->
                <div class="d-flex flex-wrap align-items-center mb-4 gap-3">
                    <!-- Search box -->
                    <div class="input-group flex-grow-1" style="max-width: 300px;">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="search"
                               class="form-control"
                               id="agent-search"
                               placeholder="Search agent name…"
                               aria-label="Search agents">
                    </div>

                    <!-- Status filter -->
                    <select class="form-select w-auto" id="status-filter" aria-label="Filter by status">
                        <option value="">All statuses</option>
                        <option value="online">Online</option>
                        <option value="idle">Idle</option>
                        <option value="busy">Busy</option>
                        <option value="offline">Offline</option>
                        <option value="error">Error</option>
                    </select>

                    <!-- Capability filter -->
                    <select class="form-select w-auto" id="capability-filter" multiple aria-label="Filter by capabilities">
                        <!-- options will be injected dynamically -->
                    </select>

                    <!-- Alert badge -->
                    <button class="btn btn-outline-danger d-flex align-items-center gap-2"
                            id="alert-toggle"
                            data-bs-toggle="collapse"
                            data-bs-target="#alert-panel"
                            aria-controls="alert-panel"
                            aria-expanded="false"
                            title="Show/hide alerts">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <span id="alert-count">0</span> Alerts
                    </button>
                </div>

                <!-- Alert Panel -->
                <div class="collapse mb-4" id="alert-panel" aria-live="polite">
                    <div class="list-group" id="alert-list">
                        <div class="list-group-item text-muted">
                            <i class="bi bi-info-circle me-2"></i>No alerts at this time.
                        </div>
                    </div>
                </div>

                <!-- Agent Status Cards Grid -->
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="agent-cards-container">
                    <!-- Loading placeholder -->
                    <div class="col-12">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading agents...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Detail Modal -->
            <div class="modal fade" id="agentDetailModal" tabindex="-1" aria-labelledby="agentDetailLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="agentDetailLabel">
                                Agent <span id="modal-agent-id"></span> – <span id="modal-agent-name"></span>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body">
                            <!-- Tab navigation -->
                            <ul class="nav nav-tabs mb-3" id="detailTabNav" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active"
                                            id="status-tab"
                                            data-bs-toggle="tab"
                                            data-bs-target="#status-tab-pane"
                                            type="button"
                                            role="tab"
                                            aria-controls="status-tab-pane"
                                            aria-selected="true">Status</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link"
                                            id="metrics-tab"
                                            data-bs-toggle="tab"
                                            data-bs-target="#metrics-tab-pane"
                                            type="button"
                                            role="tab"
                                            aria-controls="metrics-tab-pane"
                                            aria-selected="false">Performance</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link"
                                            id="capabilities-tab"
                                            data-bs-toggle="tab"
                                            data-bs-target="#capabilities-tab-pane"
                                            type="button"
                                            role="tab"
                                            aria-controls="capabilities-tab-pane"
                                            aria-selected="false">Capabilities</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link"
                                            id="history-tab"
                                            data-bs-toggle="tab"
                                            data-bs-target="#history-tab-pane"
                                            type="button"
                                            role="tab"
                                            aria-controls="history-tab-pane"
                                            aria-selected="false">History</button>
                                </li>
                            </ul>

                            <div class="tab-content" id="detailTabContent">
                                <!-- Status Tab -->
                                <div class="tab-pane fade show active" id="status-tab-pane" role="tabpanel" aria-labelledby="status-tab">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <h6>Connectivity</h6>
                                            <div class="d-flex align-items-center gap-2">
                                                <span id="modal-connectivity-status" class="badge bg-success">Online</span>
                                                <span id="modal-heartbeat" class="text-muted">Last heartbeat: <time id="modal-heartbeat-ts">--</time></span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Current Load</h6>
                                            <ul class="list-unstyled mb-0" id="modal-load-list">
                                                <li>Loading...</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Performance Tab -->
                                <div class="tab-pane fade" id="metrics-tab-pane" role="tabpanel" aria-labelledby="metrics-tab">
                                    <div style="position: relative; height: 400px;">
                                        <canvas id="modal-metrics-chart"></canvas>
                                    </div>
                                </div>

                                <!-- Capabilities Tab -->
                                <div class="tab-pane fade" id="capabilities-tab-pane" role="tabpanel" aria-labelledby="capabilities-tab">
                                    <ul class="list-group" id="modal-capability-list">
                                        <li class="list-group-item">Loading...</li>
                                    </ul>
                                </div>

                                <!-- History Tab -->
                                <div class="tab-pane fade" id="history-tab-pane" role="tabpanel" aria-labelledby="history-tab">
                                    <ul class="list-group" id="modal-history-list">
                                        <li class="list-group-item">Loading...</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Agents management -->
        <section id="agentsSection" class="row g-4 d-none">

            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-robot me-2"></i>Agents
                        </h5>
                        <button id="openAddAgentModal" class="btn btn-sm btn-outline-light" 
                                data-bs-toggle="modal" data-bs-target="#agentModal">
                            <i class="bi bi-plus-lg me-1"></i>Add Agent
                        </button>
                    </div>
                    <div class="card-body overflow-auto" style="max-height: 500px;">
                        <table class="table table-hover table-sm" id="agentsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Last Heartbeat</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                        <p id="agentsEmpty" class="text-center text-muted mt-3 d-none">
                            <i class="bi bi-inbox me-2"></i>No agents registered.
                        </p>
                    </div>
                </div>
            </div>

        </section>

        <!-- Task Execution Controls and Logs (WUI4) -->
        <section id="tasksSection" class="d-none">
            <div class="container-fluid">

                <!-- Toolbar – bulk actions, filters, quick actions -->
                <div class="row mb-3 align-items-center">
                    <div class="col-auto">
                        <!-- bulk‑actions dropdown, disabled when nothing is selected -->
                        <div class="dropdown">
                            <button type="button" id="bulk-action-btn" class="btn btn-secondary dropdown-toggle" 
                                    disabled data-bs-toggle="dropdown" aria-expanded="false">
                                Bulk Actions
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="bulk-action-btn">
                                <li><button class="dropdown-item" data-action="start">
                                    <i class="bi bi-play-fill me-2"></i>Start
                                </button></li>
                                <li><button class="dropdown-item" data-action="pause">
                                    <i class="bi bi-pause-fill me-2"></i>Pause
                                </button></li>
                                <li><button class="dropdown-item" data-action="resume">
                                    <i class="bi bi-play-circle me-2"></i>Resume
                                </button></li>
                                <li><button class="dropdown-item" data-action="stop">
                                    <i class="bi bi-stop-fill me-2"></i>Stop
                                </button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item text-danger" data-action="delete">
                                    <i class="bi bi-trash me-2"></i>Delete
                                </button></li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-auto ms-auto">
                        <form id="task-search-form" class="d-flex align-items-center">
                            <input type="search" id="task-search" class="form-control form-control-sm me-2"
                                   placeholder="Search tasks…" aria-label="Search tasks">
                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-search"></i>
                            </button>
                        </form>
                    </div>

                    <div class="col-auto">
                        <!-- quick‑action (template) modal trigger -->
                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal"
                                data-bs-target="#quicktemplate-modal">
                            <i class="bi bi-plus-lg me-1"></i>Quick Task
                        </button>
                    </div>
                </div>

                <!-- TASKS TABLE -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="tasks-table" aria-label="Task list table">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">
                                    <input type="checkbox" id="select-all" class="form-check-input" 
                                           aria-label="Select all tasks">
                                </th>
                                <th scope="col">Task ID</th>
                                <th scope="col">Name</th>
                                <th scope="col">Status</th>
                                <th scope="col">Priority</th>
                                <th scope="col">Queue Position</th>
                                <th scope="col">Started At</th>
                                <th scope="col">Duration</th>
                                <th scope="col" class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- PAGINATION -->
                <nav aria-label="Task list pagination">
                    <ul class="pagination justify-content-center" id="task-pagination">
                        <!-- Populated by JavaScript -->
                    </ul>
                </nav>

                <!-- PERFORMANCE METRICS -->
                <div id="task-metrics" class="mt-5">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-graph-up me-2"></i>Real-time Performance Metrics
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="metrics-chart" aria-label="Task execution metrics" role="img"></canvas>
                        </div>
                    </div>
                </div>

                <!-- LIVE LOG VIEWER -->
                <div id="log-viewer" class="mt-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-terminal me-2"></i>Live Task Logs
                            </h5>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" id="clear-logs-btn">
                                    <i class="bi bi-trash me-1"></i>Clear
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="pause-logs-btn">
                                    <i class="bi bi-pause-fill me-1"></i>Pause
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="download-logs-btn">
                                    <i class="bi bi-download me-1"></i>Download
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="log-container" id="log-container">
                                <pre id="log-output" class="mb-0"></pre>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Configuration Management Section (WUI6) -->
        <section id="configurationSection" class="d-none">
            <div class="container-fluid py-4">

                <!-- Breadcrumb / page header -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h1 class="h4 mb-0">Configuration Management</h1>
                    <div>
                        <button class="btn btn-success btn-sm" id="btn-export">
                            <i class="bi bi-cloud-arrow-down"></i> Export
                        </button>
                        <label class="btn btn-outline-primary btn-sm mb-0">
                            <i class="bi bi-upload"></i> Import 
                            <input type="file" id="file-import" accept=".json" hidden>
                        </label>
                        <button class="btn btn-info btn-sm" id="btn-history">
                            <i class="bi bi-clock-history"></i> History
                        </button>
                    </div>
                </div>

                <!-- Alert section (success / error) -->
                <div id="alert-area"></div>

                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="configTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-main" data-bs-toggle="tab" data-bs-target="#pane-main" type="button" role="tab">System Wide</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-agents" data-bs-toggle="tab" data-bs-target="#pane-agents" type="button" role="tab">Agents</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-discovery" data-bs-toggle="tab" data-bs-target="#pane-discovery" type="button" role="tab">Discovery Service</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-web" data-bs-toggle="tab" data-bs-target="#pane-web" type="button" role="tab">Web Interface</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-security" data-bs-toggle="tab" data-bs-target="#pane-security" type="button" role="tab">Security</button>
                    </li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content" id="configTabsContent">

                    <!-- 1) System‑wide pane -->
                    <div class="tab-pane fade show active p-3 border rounded-3" id="pane-main" role="tabpanel">
                        <form id="form-system" class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label" for="timezone">Timezone</label>
                                <select id="timezone" name="timezone" class="form-select">
                                    <!-- Populate by JS -->
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label" for="language">Language</label>
                                <select id="language" name="language" class="form-select">
                                    <option value="en">English</option>
                                    <option value="de">Deutsch</option>
                                    <option value="fr">Français</option>
                                    <option value="es">Español</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label" for="logLevel">Log Level</label>
                                <select id="logLevel" name="logLevel" class="form-select">
                                    <option value="debug">Debug</option>
                                    <option value="info">Info</option>
                                    <option value="warn">Warn</option>
                                    <option value="error">Error</option>
                                </select>
                            </div>

                            <div class="col-12 d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" id="reset-system">Reset</button>
                                <button type="submit" class="btn btn-primary">Save System Settings</button>
                            </div>
                        </form>
                    </div>

                    <!-- 2) Agents pane -->
                    <div class="tab-pane fade p-3 border rounded-3" id="pane-agents" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-12">
                                <h5>Agent List</h5>
                                <ul class="list-group" id="agent-list">
                                    <!-- JS will populate each <li> with toggleable forms -->
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 3) Discovery pane -->
                    <div class="tab-pane fade p-3 border rounded-3" id="pane-discovery" role="tabpanel">
                        <form id="form-discovery" class="row g-3">
                            <div class="col-md-6">
                                <label class="form-check-label">
                                    <input type="checkbox" class="form-check-input" id="discovery-enabled" name="enabled">
                                    Enable Discovery Service
                                </label>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" for="discovery-interval">Scan Interval (s)</label>
                                <input type="number" class="form-control" id="discovery-interval" name="interval" min="5" required>
                            </div>

                            <div class="col-12 d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" id="reset-discovery">Reset</button>
                                <button type="submit" class="btn btn-primary">Save Discovery Settings</button>
                            </div>
                        </form>
                    </div>

                    <!-- 4) Web Interface pane -->
                    <div class="tab-pane fade p-3 border rounded-3" id="pane-web" role="tabpanel">
                        <form id="form-web" class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label" for="theme">Theme</label>
                                <select id="theme" name="theme" class="form-select">
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label" for="refresh-interval">Dashboard Refresh (s)</label>
                                <input type="number" class="form-control" id="refresh-interval" name="refreshInterval" min="5" required>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label" for="layout">Layout</label>
                                <select id="layout" name="layout" class="form-select">
                                    <option value="grid">Grid</option>
                                    <option value="list">List</option>
                                </select>
                            </div>

                            <div class="col-12 d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" id="reset-web">Reset</button>
                                <button type="submit" class="btn btn-primary">Save Web Settings</button>
                            </div>
                        </form>
                    </div>

                    <!-- 5) Security pane -->
                    <div class="tab-pane fade p-3 border rounded-3" id="pane-security" role="tabpanel">
                        <form id="form-security" class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label" for="auth-method">Auth Method</label>
                                <select id="auth-method" name="authMethod" class="form-select">
                                    <option value="basic">Basic Auth</option>
                                    <option value="token">Token Auth</option>
                                    <option value="oauth">OAuth2</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label" for="token-ttl">Token TTL (min)</label>
                                <input type="number" class="form-control" id="token-ttl" name="tokenTTL" min="1" required>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label" for="audit-log">Audit Log</label>
                                <select id="audit-log" name="auditLog" class="form-select">
                                    <option value="enabled">Enabled</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                            </div>

                            <div class="col-12 d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" id="reset-security">Reset</button>
                                <button type="submit" class="btn btn-primary">Save Security Settings</button>
                            </div>
                        </form>
                    </div>

                </div> <!-- end .tab-content -->

                <!-- -------------- Modals -------------- -->

                <!-- History & Rollback modal -->
                <div class="modal fade" id="modalHistory" tabindex="-1" aria-labelledby="historyLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="historyLabel">Configuration History</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="history-body">
                                <!-- History list will populate here -->
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>User</th>
                                            <th>Comment</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-table-body">
                                        <!-- rows inserted by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

    </main>

    <!-- ==== MODALS ==== -->

    <!-- Quick Task Template Modal -->
    <div class="modal fade" id="quicktemplate-modal" tabindex="-1" aria-labelledby="quicktemplate-label" aria-hidden="true">
        <div class="modal-dialog">
            <form id="quicktask-form" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quicktemplate-label">Create Quick Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quicktask-name" class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="quicktask-name" required
                               placeholder="e.g., Process data batch">
                    </div>
                    <div class="mb-3">
                        <label for="quicktask-command" class="form-label">Command</label>
                        <input type="text" class="form-control" id="quicktask-command" required
                               placeholder="e.g., process --input data.csv">
                    </div>
                    <div class="mb-3">
                        <label for="quicktask-priority" class="form-label">Priority</label>
                        <select class="form-select" id="quicktask-priority">
                            <option value="1">Very High</option>
                            <option value="2">High</option>
                            <option value="3" selected>Medium</option>
                            <option value="4">Low</option>
                            <option value="5">Very Low</option>
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="quicktask-async">
                        <label class="form-check-label" for="quicktask-async">
                            Run asynchronously
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-play-fill me-1"></i>Create & Start
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add / Edit Agent Modal -->
    <div class="modal fade" id="agentModal" tabindex="-1" aria-labelledby="agentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form class="modal-content" id="agentForm">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="agentModalLabel">Add Agent</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="agentIdInput">
                    <div class="mb-3">
                        <label for="agentNameInput" class="form-label">Agent Name</label>
                        <input type="text" class="form-control" id="agentNameInput" 
                               placeholder="e.g., Data Processor Agent" required>
                    </div>
                    <div class="mb-3">
                        <label for="agentStatusSelect" class="form-label">Status</label>
                        <select class="form-select" id="agentStatusSelect" required>
                            <option value="online">Online</option>
                            <option value="idle">Idle</option>
                            <option value="busy">Busy</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                    <div id="agentFormError" class="alert alert-danger d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Save Agent
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast container (Bootstrap 5) -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
        <div id="toastContainer" class="toast-container"></div>
    </div>

    <!-- Bootstrap JS (with Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+4e1r5xY6V/+5P4bYk6j9R+6Fh+Q4"
            crossorigin="anonymous"></script>

    <!-- Custom JavaScript -->
    <script src="/static/js/dashboard.js" type="module"></script>
</body>
</html>
