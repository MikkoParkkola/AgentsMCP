{{- if .Values.tests.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "agentsmcp.fullname" . }}-test-connection"
  namespace: {{ include "agentsmcp.namespace" . }}
  labels:
    {{- include "agentsmcp.labels" . | nindent 4 }}
    component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: wget
    image: {{ .Values.tests.image.registry }}/{{ .Values.tests.image.repository }}:{{ .Values.tests.image.tag }}
    imagePullPolicy: {{ .Values.tests.image.pullPolicy }}
    command: ['sh', '-c']
    args:
      - |
        set -e
        echo "Testing connection to {{ include "agentsmcp.fullname" . }}:{{ .Values.service.port }}"
        
        # Test basic connectivity
        curl -f http://{{ include "agentsmcp.fullname" . }}:{{ .Values.service.port }}/health
        echo "âœ… Health check endpoint is accessible"
        
        # Test readiness endpoint
        curl -f http://{{ include "agentsmcp.fullname" . }}:{{ .Values.service.port }}/health/ready
        echo "âœ… Readiness check endpoint is accessible"
        
        # Test liveness endpoint
        curl -f http://{{ include "agentsmcp.fullname" . }}:{{ .Values.service.port }}/health/live
        echo "âœ… Liveness check endpoint is accessible"
        
        # Test API root
        curl -f http://{{ include "agentsmcp.fullname" . }}:{{ .Values.service.port }}/
        echo "âœ… API root endpoint is accessible"
        
        # Test capabilities endpoint
        curl -f http://{{ include "agentsmcp.fullname" . }}:{{ .Values.service.port }}/capabilities
        echo "âœ… Capabilities endpoint is accessible"
        
        {{- if .Values.monitoring.enabled }}
        # Test metrics endpoint
        curl -f http://{{ include "agentsmcp.fullname" . }}:{{ .Values.service.port }}/metrics
        echo "âœ… Metrics endpoint is accessible"
        {{- end }}
        
        echo "ðŸŽ‰ All connection tests passed!"
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 65534
      capabilities:
        drop:
        - ALL
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        cpu: 100m
        memory: 128Mi
{{- end }}