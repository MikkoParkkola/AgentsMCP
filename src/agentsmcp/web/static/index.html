<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AgentsMCP UI</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
      .card { border: 1px solid #ddd; padding: 1rem; border-radius: 8px; }
      pre { background: #f7f7f7; padding: 0.5rem; border-radius: 4px; }
    </style>
  </head>
  <body>
    <h1>AgentsMCP Dashboard</h1>
    <div class="grid">
      <div class="card">
        <h3>Status</h3>
        <div id="status">Loadingâ€¦</div>
      </div>
      <div class="card">
        <h3>Spawn Job</h3>
        <form id="spawn-form">
          <div>
            <label>Agent:</label>
            <input id="agent" value="codex" />
          </div>
          <div>
            <label>Task:</label>
            <input id="task" value="Say hello" />
          </div>
          <button type="submit">Spawn</button>
        </form>
        <pre id="spawn-result"></pre>
      </div>
      <div class="card">
        <h3>Jobs</h3>
        <pre id="jobs" style="height:200px; overflow:auto"></pre>
        <div>
          <input id="cancel-id" placeholder="job id" />
          <button id="cancel-btn">Cancel</button>
        </div>
      </div>
      <div class="card">
        <h3>Events</h3>
        <pre id="events" style="height:200px; overflow:auto"></pre>
      </div>
      <div class="card">
        <h3>Metrics</h3>
        <canvas id="chart" width="300" height="160" style="border:1px solid #ddd"></canvas>
      </div>
    </div>
    <script>
      async function refreshStats(){
        try {
          const r = await fetch('/stats');
          const j = await r.json();
          document.getElementById('status').textContent = JSON.stringify(j, null, 2);
        } catch (e) {
          document.getElementById('status').textContent = 'Error: ' + e;
        }
        // list current jobs
        try {
          const rj = await fetch('/jobs');
          const jj = await rj.json();
          document.getElementById('jobs').textContent = JSON.stringify(jj, null, 2);
        } catch {}
      }
      }
      refreshStats();
      setInterval(refreshStats, 3000);
      async function refreshMetrics(){
        try {
          const r = await fetch('/metrics');
          const j = await r.json();
          const ctx = document.getElementById('chart').getContext('2d');
          const keys = ['completed','failed','cancelled','timeout','running','pending'];
          const vals = keys.map(k => j.counts[k] || 0);
          const max = Math.max(1, ...vals);
          ctx.clearRect(0,0,300,160);
          vals.forEach((v,i) => {
            const h = Math.round((v/max)*120);
            const x = 10 + i*45;
            const y = 140 - h;
            ctx.fillStyle = '#4a90e2';
            ctx.fillRect(x, y, 30, h);
            ctx.fillStyle = '#333';
            ctx.fillText(keys[i].slice(0,3), x, 155);
          });
        } catch (e) {}
      }
      setInterval(refreshMetrics, 3000); refreshMetrics();

      // SSE subscribe
      try {
        const ev = new EventSource('/events');
        ev.onmessage = (msg) => {
          const el = document.getElementById('events');
          el.textContent += msg.data + '\n';
          el.scrollTop = el.scrollHeight;
        };
      } catch (e) {}

      // spawn handler
      document.getElementById('spawn-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const agent = document.getElementById('agent').value;
        const task = document.getElementById('task').value;
        const r = await fetch('/spawn', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({agent_type: agent, task, timeout: 120})});
        const j = await r.json();
        document.getElementById('spawn-result').textContent = JSON.stringify(j, null, 2);
      });

      document.getElementById('cancel-btn').addEventListener('click', async () => {
        const id = document.getElementById('cancel-id').value.trim();
        if (!id) return;
        const r = await fetch('/jobs/' + id, {method:'DELETE'});
        const j = await r.json();
        alert('Cancel: ' + JSON.stringify(j));
      });
    </script>
  </body>
  </html>
